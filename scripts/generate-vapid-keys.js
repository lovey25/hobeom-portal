#!/usr/bin/env node

/**
 * VAPID í‚¤ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 * Web Push APIë¥¼ ìœ„í•œ ê³µê°œí‚¤/ë¹„ê³µê°œí‚¤ ìŒ ìƒì„±
 *
 * ì‚¬ìš©ë²•: node scripts/generate-vapid-keys.js
 */

const webpush = require("web-push");
const fs = require("fs");
const path = require("path");

console.log("ğŸ”‘ VAPID í‚¤ ìƒì„± ì¤‘...\n");

// VAPID í‚¤ ìƒì„±
const vapidKeys = webpush.generateVAPIDKeys();

console.log("âœ… VAPID í‚¤ ìƒì„± ì™„ë£Œ!\n");
console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
console.log("ğŸ“‹ ì•„ë˜ ë‚´ìš©ì„ .env.local íŒŒì¼ì— ì¶”ê°€í•˜ì„¸ìš”:\n");
console.log("NEXT_PUBLIC_VAPID_PUBLIC_KEY=" + vapidKeys.publicKey);
console.log("VAPID_PRIVATE_KEY=" + vapidKeys.privateKey);
console.log("VAPID_SUBJECT=mailto:admin@hobeom-portal.com");
console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

// .env.local íŒŒì¼ ìë™ ìƒì„±/ì—…ë°ì´íŠ¸
const envPath = path.join(__dirname, "..", ".env.local");
let envContent = "";

// ê¸°ì¡´ .env.local íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ê¸°
if (fs.existsSync(envPath)) {
  envContent = fs.readFileSync(envPath, "utf8");
  console.log("ğŸ“ ê¸°ì¡´ .env.local íŒŒì¼ ë°œê²¬, ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤...");

  // VAPID ê´€ë ¨ ê¸°ì¡´ ì„¤ì • ì œê±°
  envContent = envContent
    .split("\n")
    .filter(
      (line) =>
        !line.startsWith("NEXT_PUBLIC_VAPID_PUBLIC_KEY=") &&
        !line.startsWith("VAPID_PRIVATE_KEY=") &&
        !line.startsWith("VAPID_SUBJECT=")
    )
    .join("\n");

  // ë¹ˆ ì¤„ ì •ë¦¬
  envContent = envContent.trim() + "\n\n";
} else {
  console.log("ğŸ“ ìƒˆ .env.local íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤...");
}

// VAPID ì„¤ì • ì¶”ê°€
envContent += "# Web Push VAPID Keys (generated by scripts/generate-vapid-keys.js)\n";
envContent += `NEXT_PUBLIC_VAPID_PUBLIC_KEY=${vapidKeys.publicKey}\n`;
envContent += `VAPID_PRIVATE_KEY=${vapidKeys.privateKey}\n`;
envContent += `VAPID_SUBJECT=mailto:admin@hobeom-portal.com\n`;

// íŒŒì¼ ì €ì¥
fs.writeFileSync(envPath, envContent);

console.log("âœ… .env.local íŒŒì¼ì— ì €ì¥ ì™„ë£Œ!\n");
console.log("âš ï¸  ë³´ì•ˆ ì£¼ì˜ì‚¬í•­:");
console.log("   - .env.local íŒŒì¼ì€ ì ˆëŒ€ Gitì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”");
console.log("   - í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•˜ì„¸ìš”");
console.log("   - VAPID_PRIVATE_KEYëŠ” ì™¸ë¶€ì— ë…¸ì¶œë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤\n");
console.log("ğŸš€ ë‹¤ìŒ ë‹¨ê³„: npm run dev ì¬ì‹œì‘");
